<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link href="http://vjs.zencdn.net/6.6.3/video-js.css" rel="stylesheet">
    <link rel="stylesheet" href="videojs.ads.css">
    <!-- If you'd like to support IE8 -->
    <script src="http://vjs.zencdn.net/ie8/1.1.2/videojs-ie8.min.js"></script>
</head>

<body>
    <video id="examplePlayer" class="video-js" width="640" height="264" poster="http://vjs.zencdn.net/v/oceans.png" preload="auto"
        controls data-setup="{}">
        <source src="http://vjs.zencdn.net/v/oceans.mp4" type='video/mp4' />
        <source src="http://vjs.zencdn.net/v/oceans.webm" type='video/webm' />
        <source src="http://vjs.zencdn.net/v/oceans.ogv" type='video/ogg' />
        <track kind="metadata"> </track>
    </video>
    <video id="exampleAdContainer" class="video-js ad-container vjs-hidden" width="640" height="264" preload="auto" controls>
    </video>

    <script src="video.js"></script>
    <script src="videojs-playlist.js"></script>
    <script src="videojs.ads.js"></script>
    <script>


        videojs('examplePlayer').ready(function () {

            var player = this;
            var lastVisitIndex = localStorage.getItem('lastVisitIndex') !== null ? parseFloat(localStorage.getItem('lastVisitIndex')) : 0;
            var lastVisitTime = localStorage.getItem('lastVisitTime') !== null ? parseFloat(localStorage.getItem('lastVisitTime')) : 0;
            var samplePlaylist = [{
                sources: [{
                    src: 'http://media.w3.org/2010/05/sintel/trailer.mp4',
                    type: 'video/mp4',
                }],
                poster: 'http://media.w3.org/2010/05/sintel/poster.png',
                textTracks: [{
                    kind: 'metadata',
                    src: './testcuepoint_1.vtt'
                }]
            }, {
                sources: [{
                    src: 'http://media.w3.org/2010/05/bunny/trailer.mp4',
                    type: 'video/mp4'
                }],
                poster: 'http://media.w3.org/2010/05/bunny/poster.png',
                textTracks: [{
                    kind: 'metadata',
                    src: './testcuepoint_2.vtt'
                }]
            }];
            player.playlist(samplePlaylist, lastVisitIndex);
            player.playlist.autoadvance(0);
            player.playlist.repeat(true);
            player.autoplay(true);
            player.currentTime(lastVisitTime);

            setInterval(() => {
                lastVisitIndex = player.playlist.currentIndex();
                lastVisitTime = player.currentTime();
                localStorage.setItem('lastVisitIndex', lastVisitIndex);
                localStorage.setItem('lastVisitTime', lastVisitTime);
            }, 60);

            var adContainer = videojs('exampleAdContainer');
            var adServerUrl = "inventory.json";
            var originalSrc = player.currentSrc();
            var state = {};
            var playedCues = {};

            // asynchronous method for requesting ad inventory
            var requestAds = function () {
                videojs.log('example', 'Requesting an ad');

                // reset plugin state
                state = {};

                // fetch ad inventory
                // the 'src' parameter is ignored by the example inventory.json flat file,
                // but this shows how you might send player information along to the ad server.
                var xhr = new XMLHttpRequest();
                xhr.open("GET", adServerUrl + "?src=" + encodeURIComponent(player.currentSrc()));

                xhr.onreadystatechange = function () {
                    if (xhr.readyState === 4) {
                        try {
                            state.inventory = JSON.parse(xhr.responseText);
                            player.trigger('adsready');
                        } catch (err) {
                            throw new Error('Couldn\'t parse inventory response as JSON');
                        }
                    }
                };
                xhr.send(null);

            };

            var switchMode = function (mode, src) {
                // switch to ad mode
                if (mode === 'ad') {
                    videojs.log('example', 'Going into ad mode with', src.src);

                    // pause content immediately
                    player.pause();

                    // show ad container, hide content player
                    adContainer.src(src);
                    adContainer.removeClass('vjs-hidden');
                    player.addClass('vjs-hidden');

                    // play ad
                    adContainer.play();

                } else if (mode === 'content') {
                    videojs.log('example', 'Going into content mode with', src);

                    // hide ad container, show content player
                    player.removeClass('vjs-hidden');
                    adContainer.addClass('vjs-hidden');

                    // resume content
                    player.play();
                }
            };

            var cueChangeHandler = function (event) {
                if (state.adPlaying || !this.activeCues || this.activeCues.length === 0) {
                    return;
                }
                var activeCue = this.activeCues[this.activeCues.length - 1];
                var cues = [activeCue];

                videojs.log('example', 'A cue change fired at', player.currentTime(),
                    'cue is', cues[0], 'at', cues[0].startTime);

                // Make an ad request
                var processCue = function (player, cue, cueId, startTime) {
                    if (cue.text != 'ad' || player.paused() ||
                        state.adPlaying || playedCues[cueId]) {
                        return;
                    }

                    playAd();
                    // Will Play Add in playlist every time
                    playedCues[cueId] = false;
                };

                // Optional method to dynamically cancel ads
                var cancelAds = function (player, cue) {
                    if (cue.text === 'adCancel' && state.adPlaying) {
                        state.adPlaying = false;
                        player.ads.endLinearAdMode();
                        switchMode('content', originalSrc);
                    }
                };

                // Process the cues in this track as ad cues using `processCue`
                // Cancel ads dynamically using `cancelAds`
                player.ads.cueTextTracks.processAdTrack(player, cues, processCue, cancelAds);
            };

            // play an ad, given an opportunity
            var playAd = function () {
                // short-circuit if we don't have any ad inventory to play
                if (!state.inventory || state.inventory.length === 0) {
                    return;
                }

                // tell ads plugin we're ready to play our ad
                player.ads.startLinearAdMode();
                state.adPlaying = true;

                // tell videojs to load the ad
                var media = state.inventory[Math.floor(Math.random() * state.inventory.length)];
                switchMode('ad', media);
            };

            var processMetadataTrack = function (player, track) {
                track.addEventListener('cuechange', cueChangeHandler);
            }

            // initialize the ads plugin, passing in any relevant options
            player.ads({
                debug: true
            });

            // Set up to process metadata cues
            player.ads.cueTextTracks.processMetadataTracks(player, processMetadataTrack);

            // Log when the remote text track is added
            player.textTracks().addEventListener('addtrack', function (event) {
                videojs.log('example', 'a track was added');
            });

            // Set up a base text track to use for our ad cuepoints
            // player.addRemoteTextTrack();

            // indicate that there will be no preroll and postroll
            player.trigger('nopreroll');
            player.trigger('nopostroll');

            // Set up to return from ads
            adContainer.on('ended', function (e) {
                if (!state.adPlaying) {
                    return;
                }

                // play your linear ad content, then when it's finished ...
                player.ads.endLinearAdMode();
                state.adPlaying = false;
                switchMode('content', originalSrc);

                // re-enable the text track
                player.textTracks()[0].mode = 'hidden';
            });

            // request ad inventory whenever the player gets new content to play
            if (player.currentSrc() && player.paused()) {
                requestAds();
            }

            // Implement an interface for understanding the adCues

            player.ads.cueTextTracks.setMetadataTrackMode = function (track) {
                // The cues are invisible, so set them to hidden so they can be updated
                track.mode = 'hidden';
            };

            player.ads.cueTextTracks.getSupportedAdCue = function (player, cue) {
                // Make sure this is an ad cue
                if (cue.text === 'ad' || cue.text === 'adCancel') {
                    return cue;
                }

                return -1;
            };

            player.ads.cueTextTracks.getCueId = function (player, cue) {
                // Return the topmost id
                return Number(cue.id);
            };

        });
    </script>
</body>

</html>